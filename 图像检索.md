# 图像检索

**背景**

基于CNN的图像搜索的pipeline:端到端学习输入图像的global feature，然后根据这个feature进行相似性度量。如人脸识别，行人重识别等领域，通过metric learning为每张输入图片学到一个固定长度的特征，通过常见距离度量方式进行相似度对比，排序就行。

人脸，人体，车辆可视为细分领域的细粒度检索，通过兴趣区域的检测，有着良好的关键点信息，具有明确语义的关键点对细粒度特征挖掘帮助很大，但对于通用的图像检索，往往没有明确 的语义关键信息，比如商品检索，landmark检索

以字搜图，以图搜图

虽然没有一种十分有效的特征描述子能够获取图像的高级语义特征，但是，如果提取一些有效的图像描述子以便于检索和储存是有实际的研究价值

研究的主要方向：新的图像特征，表示方法以及相似度的计算 --》 人机交互的半自动图像检索

研究热点： 图像底层特征的提取，基于区域的图像检索（通过图像分割将图像分为不同区域，对每个区域使用局部特征进行描述，综合得到总体特征，最后用合适的相似度标准检索），图像语义特征提取，高维索引技术，半自动图像交互式，性能评价（缺少在相同数据集和查询条件下对不同检索系统进行有效性的而对比实验，难以确定什么标准更有效）

###  DELF

这是一种用于大规模检索的注意力局部特征表达

以图搜图的图像检索是CBIR 任务中最难的一块，一般是由于图像拍摄角度的问题，有些是只显示了局部信息，有些则有全局信息，这种情况下，图像检索匹配的效果以往算法表现一般，而DELF模型是 ICCV 2017 和CVPR 2018提到的当前效果最好的以图搜图的模型，这是一种基于图像对象 instance 的检索匹配

整个系统包括四个部分：

1. 提取密集的局部特征，作者采用了ResNet50的全连接层进行特征提取

   > 在imagenet上预训练的resnet50模型，进行微调，
   >
   > 数据处理是rescale到250X250，随机crop到224 X224

2. 关键点选择，论文的关键部分，除了注意力机制的使用，作者直接再高层的语义上进行关键点的检测，而不是在原图上检测

   > 论文中用的ResNet50 conv4_x的输出接入attention模块，来获得局部特征表达的相关得分，为了能够训练该函数，首先使用加权的求和池化对特征进行降维，该权重是attention网络的预测
   >
   > 解决尺寸变化问题：构建图像金字塔，对每级都是用FCN，获得特征看成是局部表达的稠密网络，根据感受也可以对特征进行定位，根据卷积层和池化层的参数可以获得特征图的大小
   >
   > rescale to 900X90，随机crop到720x720， rescale gamma < 1
   >
   > 实现了两个目的：
   >
   > 1. 训练了在特征图中比编码更高级语义信息
   > 2. 挑选了使用于分类任务的判别特征

3. 降维，主要办法是用L2正则化，再用PCA降维

   > 对选定的特征进行降维，来获得较好的检索准确率，进行l2正则，运用PCA讲到40，40是对紧凑性和判别性的一个很好的而平衡，最后对特征再使用正则化

4. 索引提取，作者用KD树进行索引

   > 每张图 1000 * 40,1000个局部特征，每个特征40d，远远大于了CNN的global feature
   >
   > 给定一张查询图像，先从查询图像中提取的每个局部特征进行近似最近邻搜索，对于从索引中检索出的前topk（60）个局部特征，对数据库中的每张图像的所有匹配进行聚合，最后，使用RANSAC进行几何验证，用局内点的数量代表检索图像的得分
   >
   > 生成图像特征，通过kd树进行特征点匹配，匹配完成后，通过ransac算法进行几何约束，进一步优化匹配点，得到图像的匹配结果，以及匹配点个数

5. 创新点是只利用图像级标签信息，训练的局部特征提取方法，一次前向传播就能完成关键点检测和特征表达，传统的先选择关键点再提取特征；

6. 缺点，特征量太大，图像金字塔需要7次前向传播

把所有图像的特征取出来后，对所有的特征维度进行降维后为pca_feat，对随机查询的图像的pca_feat[i]和pca_feat中所有的特征一一进行度量计算，排序选出最近的前k个



将描述符聚合为全局表示，可以通过两种方式，一种编码，如FV， VLAD，一种池化

有人发现在最后一层卷积层如VGG的pool5在池化后达到的准确度要高于fc和其他卷积层的结果

也有用RPN来进行目标定位

也有图像的类别检索，其主要包括两个部分，一个是网络结构的构造，另外一个是使用粗检索与细检索结合的方式。具体如下：

（1）其使用的CNN网络最后两层为全连接层，用F7和F8表示，整个网络在imagenet上进行预训练。在两个全连接层之间加入一个隐层，其激活函数使用sigmoid函数，这样在最后的输出层就变成了（0,1）之间的表示，最后在通过设定阈值组成哈希编码（就是转变成了使用二进制编码表示图像类别）

（2）粗检索使用汉明距离（汉明距离指的是两个二进制数中不相同位的数量）进行检索图像，设定一个距离阈值，当小于这个阈值的时候，被纳入到细致的待检测环节中。在细致的检索中，使用FC7层进行新的特征，以及欧式距离进行进一步的检索